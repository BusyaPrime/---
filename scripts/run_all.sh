#!/bin/bash
set -e

echo "==========================================="
echo " PDE-LAB: Генерация Пруфов для Архитектора "
echo "==========================================="

# 1. Собираем жирный джарник (кто юзает мелкие - тот джун)
echo "[1/4] Билдим pdelab-all.jar (вместе со всеми потрохами)..."
./gradlew clean shadowJar -x test

# 2. Гоняем матан-верификацию (MMS пруфы, что код решает уравнения, а не хрень)
echo "[2/4] Запускаем Хардкорную Матан-Верификацию..."
java -jar build/libs/pdelab-all.jar verify

# 3. Микро-бенчмарки (JMH, выжимаем все соки из L1-кэша)
echo "[3/4] Прожариваем Микробенчи..."
java -jar build/libs/pdelab-all.jar bench

# 4. Профал и демка масштабирования (смотрим, не потек ли GC)
echo "[4/4] Снимаем JFR профиль (пруфаем zero-allocation)..."
# Большая сетка на 20 шагов, чтобы раскачать JVM и спалить аллокаторы
java -jar build/libs/pdelab-all.jar run --config config.example.json --profile=jfr

echo "==========================================="
echo "   Все пруфы железобетонно собраны!        "
echo "   Чекните папку ./artifacts/, там красота "
echo "==========================================="
